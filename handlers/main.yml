---
# handlers file for ansible-role-jenkins
- name: Restart Jenkins
  service:
    name: jenkins
    state: restarted
  notify: Wait for Jenkins
  become: True

- name: Start Jenkins
  service:
    name: jenkins
    state: started
    enabled: True
  notify: Wait for Jenkins
  become: True

- name: Wait for Jenkins
  uri:
    url: "http://{{ jenkins2_default_url }}\
          :{{ jenkins2_config_http_port }}\
          {{ jenkins2_context_path | default('') }}/login"
    status_code: 200
  register: login_page
  until: login_page.status == 200
  retries: 60
  delay: 5

# handlers for windows
- name: Restart windows Jenkins
  win_service:
    name: jenkins
    state: restarted
  notify: Wait for windows Jenkins

- name: Start windows Jenkins
  win_service:
    name: jenkins
    state: started
    enabled: True
  notify: Wait for windows Jenkins

- name: Wait for windows Jenkins
  block:
    - wait_for:
        host: '{{ jenkins2_inventory_ip }}'
        port: '{{ jenkins2_config_http_port }}'
        delay: 10
    delegate_to: localhost
    - win_uri:
        url: "http://{{ jenkins2_inventory_ip }}\
            :{{ jenkins2_config_http_port }}\
            {{ jenkins2_context_path | default('') }}/login"
        return_content: True
        status_code: 200
    register: login_page_win
    until: login_page_win.status_code == 200
    retries: 30
    delay: 5

- name: Restart Jenkins with HTTPS
  service:
    name: jenkins
    state: restarted
  notify: Wait for Jenkins with HTTPS
  become: True

- name: Wait for Jenkins with HTTPS
  uri:
    url: "https://{{ jenkins2_default_url }}\
          :{{ jenkins2_config_http_port }}\
          {{ jenkins2_context_path | default('') }}/login"
    status_code: 200
    validate_certs: False
  register: login_page
  until: login_page.status == 200
  retries: 60
  delay: 5
